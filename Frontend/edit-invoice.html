<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Invoice - RentComPro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 30px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar h1 { font-size: 24px; }
    .nav-links a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; transition: background 0.3s; }
    .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
    .form-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .section-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-size: 14px; font-weight: 500; color: #333; }
    input, select, textarea { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; }
    .items-section { margin-bottom: 30px; }
    .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 15px; background: #f9fafb; border-radius: 8px; }
    .item-row input { padding: 8px; }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-sm { padding: 8px 15px; font-size: 13px; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-add { background: #3b82f6; color: white; }
    .summary-box { background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 16px; }
    .summary-row.total { border-top: 2px solid #333; margin-top: 10px; padding-top: 15px; font-size: 20px; font-weight: 700; color: #667eea; }
    .action-buttons { display: flex; gap: 15px; margin-top: 30px; }
    .loading { text-align: center; padding: 40px; color: #999; }
    .message { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .message.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .message.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>üîê RentComPro</h1>
    <div class="nav-links"><a href="/invoices.html">‚Üê Back to Invoices</a></div>
  </nav>

  <div class="container">
    <div id="message" class="message"></div>
    <div id="loadingState" class="loading">Loading invoice...</div>
    
    <div id="formContainer" style="display: none;">
      <div class="form-card">
        <h2>‚úèÔ∏è Edit Invoice</h2>
        <p id="clientName" style="color: #666; margin-top: 10px;"></p>
        
        <div style="margin-top: 30px;">
          <div class="section-title">Invoice Details</div>
          <div class="form-grid">
            <div class="form-group">
              <label>Invoice Number *</label>
              <input type="text" id="invoiceNumber" required>
            </div>
            <div class="form-group">
              <label>Reference Number</label>
              <input type="text" id="referenceNumber">
            </div>
            <div class="form-group">
              <label>Invoice Date *</label>
              <input type="date" id="invoiceDate" required>
            </div>
            <div class="form-group">
              <label>Due Date *</label>
              <input type="date" id="dueDate" required>
            </div>
            <div class="form-group">
              <label>Period From *</label>
              <input type="date" id="periodFrom" required>
            </div>
            <div class="form-group">
              <label>Period To *</label>
              <input type="date" id="periodTo" required>
            </div>
            <div class="form-group full-width">
              <div class="checkbox-group">
                <input type="checkbox" id="hasGst">
                <label for="hasGst">Include GST (18%)</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-card">
        <div class="section-title">üì¶ Invoice Items</div>
        <div id="invoiceItems" class="items-section"></div>
        <button class="btn btn-add btn-sm" onclick="addItem()">+ Add Item</button>
      </div>

      <div class="form-card">
        <div class="section-title">üí∞ Additional Info</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Previous Outstanding</label>
            <input type="number" id="previousOutstanding" value="0" step="0.01">
          </div>
        </div>
      </div>

      <div class="form-card">
        <div class="section-title">üìä Summary</div>
        <div class="summary-box" id="summary">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="summarySubtotal">‚Çπ0</span>
          </div>
          <div class="summary-row">
            <span>Previous Outstanding:</span>
            <span id="summaryOutstanding">‚Çπ0</span>
          </div>
          <div class="summary-row" id="gstRow" style="display: none;">
            <span>GST @ 18%:</span>
            <span id="summaryGst">‚Çπ0</span>
          </div>
          <div class="summary-row total">
            <span>TOTAL PAYABLE:</span>
            <span id="summaryTotal">‚Çπ0</span>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="window.location.href='/invoices.html'">Cancel</button>
        <button class="btn btn-primary" onclick="updateInvoice()">üíæ Update Invoice</button>
      </div>
    </div>
  </div>

  <script>
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_URL = isLocal ? 'http://localhost:8787' : 'https://rentcompro-backend.brajesh-jimmc.workers.dev';

    const urlParams = new URLSearchParams(window.location.search);
    const invoiceId = urlParams.get('id');
    let itemCounter = 0;

    if (!invoiceId) {
      alert('Invoice ID missing');
      window.location.href = '/invoices.html';
    }

    // Load invoice data
    async function loadInvoiceData() {
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const invoice = data.data;
          
          // Check if editable
          if (invoice.status !== 'UNPAID') {
            alert(`Cannot edit invoice with status "${invoice.status}". Only UNPAID invoices can be edited.`);
            window.location.href = '/invoices.html';
            return;
          }
          
          // Fill form fields
          document.getElementById('invoiceNumber').value = invoice.invoice_number;
          document.getElementById('referenceNumber').value = invoice.reference_number || '';
          document.getElementById('invoiceDate').value = invoice.invoice_date;
          document.getElementById('dueDate').value = invoice.due_date;
          document.getElementById('periodFrom').value = invoice.period_from;
          document.getElementById('periodTo').value = invoice.period_to;
          document.getElementById('hasGst').checked = invoice.has_gst;
          document.getElementById('previousOutstanding').value = invoice.previous_outstanding;
          
          // Set client name
          if (invoice.clients) {
            document.getElementById('clientName').textContent = `Client: ${invoice.clients.company_name}`;
          }
          
          // Load items
          invoice.items.forEach(item => {
            addItem(item.description, item.quantity, item.rate, item.item_type);
          });
          
          calculateSummary();
          
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('formContainer').style.display = 'block';
          
          // Add event listeners
          document.getElementById('hasGst').addEventListener('change', calculateSummary);
          document.getElementById('previousOutstanding').addEventListener('input', calculateSummary);
        } else {
          alert('Invoice not found');
          window.location.href = '/invoices.html';
        }
      } catch (error) {
        console.error('Load invoice error:', error);
        alert('Failed to load invoice');
        window.location.href = '/invoices.html';
      }
    }

    // Add item
    function addItem(description = '', quantity = 1, rate = 0, itemType = 'RENTAL') {
      itemCounter++;
      const id = `item_${itemCounter}`;
      
      const html = `
        <div class="item-row" id="${id}">
          <input type="text" placeholder="Description" value="${description}" onchange="calculateSummary()">
          <input type="number" placeholder="Qty" value="${quantity}" min="1" onchange="calculateSummary()">
          <input type="number" placeholder="Rate" value="${rate}" step="0.01" onchange="calculateSummary()">
          <input type="number" placeholder="Amount" value="${quantity * rate}" readonly>
          <button class="btn btn-danger btn-sm" onclick="removeItem('${id}')">√ó</button>
        </div>
      `;
      
      document.getElementById('invoiceItems').insertAdjacentHTML('beforeend', html);
      calculateSummary();
    }

    // Remove item
    function removeItem(id) {
      document.getElementById(id).remove();
      calculateSummary();
    }

    // Calculate summary
    function calculateSummary() {
      let subtotal = 0;
      
      document.querySelectorAll('.item-row').forEach(row => {
        const inputs = row.querySelectorAll('input[type="number"]');
        const qty = parseFloat(inputs[0].value) || 0;
        const rate = parseFloat(inputs[1].value) || 0;
        const amount = qty * rate;
        inputs[2].value = amount.toFixed(2);
        subtotal += amount;
      });
      
      const previousOutstanding = parseFloat(document.getElementById('previousOutstanding').value) || 0;
      const hasGst = document.getElementById('hasGst').checked;
      
      const taxableAmount = subtotal + previousOutstanding;
      const gstAmount = hasGst ? taxableAmount * 0.18 : 0;
      const total = taxableAmount + gstAmount;
      
      document.getElementById('summarySubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById('summaryOutstanding').textContent = `‚Çπ${previousOutstanding.toFixed(2)}`;
      document.getElementById('summaryGst').textContent = `‚Çπ${gstAmount.toFixed(2)}`;
      document.getElementById('summaryTotal').textContent = `‚Çπ${total.toFixed(2)}`;
      
      document.getElementById('gstRow').style.display = hasGst ? 'flex' : 'none';
    }

    // Update invoice
    async function updateInvoice() {
      if (!document.getElementById('invoiceNumber').value) {
        alert('Please enter invoice number');
        return;
      }
      
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        items.push({
          itemType: 'RENTAL',
          description: inputs[0].value,
          quantity: parseFloat(inputs[1].value),
          rate: parseFloat(inputs[2].value),
          amount: parseFloat(inputs[3].value)
        });
      });
      
      if (items.length === 0) {
        alert('Please add at least one item');
        return;
      }
      
      const invoiceData = {
        invoiceNumber: document.getElementById('invoiceNumber').value,
        referenceNumber: document.getElementById('referenceNumber').value,
        invoiceDate: document.getElementById('invoiceDate').value,
        periodFrom: document.getElementById('periodFrom').value,
        periodTo: document.getElementById('periodTo').value,
        dueDate: document.getElementById('dueDate').value,
        hasGst: document.getElementById('hasGst').checked,
        previousOutstanding: parseFloat(document.getElementById('previousOutstanding').value) || 0,
        items
      };
      
      const token = localStorage.getItem('token');
      const messageEl = document.getElementById('message');
      
      try {
        messageEl.textContent = 'Updating invoice...';
        messageEl.className = 'message';
        messageEl.style.display = 'block';
        
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(invoiceData),
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageEl.textContent = '‚úÖ Invoice updated successfully!';
          messageEl.className = 'message success';
          
          setTimeout(() => {
            window.location.href = '/invoices.html';
          }, 2000);
        } else {
          messageEl.textContent = `‚ùå ${data.message}`;
          messageEl.className = 'message error';
        }
      } catch (error) {
        console.error('Update error:', error);
        messageEl.textContent = '‚ùå Failed to update invoice';
        messageEl.className = 'message error';
      }
    }

    // Initialize
    loadInvoiceData();
  </script>
</body>
</html>

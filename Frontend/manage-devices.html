<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devices - RentComPro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }

    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px 30px; color: white;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .navbar h1 { font-size: 24px; }
    .nav-links a {
      color: white; text-decoration: none; padding: 8px 15px;
      border-radius: 5px; margin-left: 10px; transition: background 0.3s;
    }
    .nav-links a:hover { background: rgba(255,255,255,0.2); }

    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

    .btn {
      padding: 12px 20px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-info    { background: #3b82f6; color: white; }
    .btn-edit    { background: #8b5cf6; color: white; }
    .btn-danger  { background: #ef4444; color: white; }
    .btn-cancel  { background: #f3f4f6; color: #555; }
    .btn-sm { padding: 8px 12px; font-size: 12px; }

    .stats-cards {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid;
    }
    .stat-card.available  { border-left-color: #10b981; }
    .stat-card.deployed   { border-left-color: #3b82f6; }
    .stat-card.maintenance{ border-left-color: #f59e0b; }
    .stat-card.retired    { border-left-color: #ef4444; }
    .stat-card .icon  { font-size: 32px; margin-bottom: 10px; }
    .stat-card .label { color: #666; font-size: 13px; margin-bottom: 5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #333; }

    .filters {
      background: white; padding: 20px; border-radius: 10px;
      margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
    }
    .filter-btn {
      padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 8px;
      background: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;
    }
    .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .search-box {
      flex: 1; padding: 10px 15px; border: 2px solid #e5e7eb;
      border-radius: 8px; font-size: 14px;
    }

    .devices-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;
    }
    .device-card {
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #667eea; transition: all 0.3s;
    }
    .device-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .device-card.available  { border-left-color: #10b981; }
    .device-card.deployed   { border-left-color: #3b82f6; }
    .device-card.maintenance{ border-left-color: #f59e0b; }
    .device-card.retired    { border-left-color: #ef4444; }

    .device-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
    .device-type {
      font-size: 12px; padding: 4px 10px; border-radius: 12px;
      font-weight: 600; background: #f3f4f6; color: #666;
    }
    .device-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
    .device-status.available  { background: #d4edda; color: #155724; }
    .device-status.deployed   { background: #cce5ff; color: #004085; }
    .device-status.maintenance{ background: #fff3cd; color: #856404; }
    .device-status.retired    { background: #f8d7da; color: #721c24; }

    .device-title  { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 10px; }
    .device-serial {
      font-size: 12px; color: #666; font-family: monospace;
      background: #f3f4f6; padding: 4px 8px; border-radius: 4px;
      display: inline-block; margin-bottom: 15px;
    }
    .device-specs {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      margin-bottom: 15px; font-size: 13px; color: #666;
    }
    .spec-item { display: flex; align-items: center; gap: 5px; }
    .device-rent { font-size: 20px; font-weight: 700; color: #667eea; margin-bottom: 15px; }
    .device-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; top:0;left:0;right:0;bottom:0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white; border-radius: 12px; padding: 30px;
      width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal h3 {
      font-size: 20px; font-weight: 700; color: #333;
      margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f3f4f6;
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1/-1; }
    .form-group label { font-size: 13px; font-weight: 600; color: #555; }
    .form-group input, .form-group select {
      padding: 10px 12px; border: 2px solid #e5e7eb;
      border-radius: 8px; font-size: 14px; transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .modal-actions {
      display: flex; gap: 10px; justify-content: flex-end;
      margin-top: 20px; padding-top: 15px; border-top: 2px solid #f3f4f6;
    }

    /* â”€â”€ CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .confirm-overlay {
      display: none; position: fixed; top:0;left:0;right:0;bottom:0;
      background: rgba(0,0,0,0.5); z-index: 2000;
      align-items: center; justify-content: center;
    }
    .confirm-overlay.active { display: flex; }
    .confirm-box {
      background: white; border-radius: 12px; padding: 30px;
      width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .confirm-box .icon { font-size: 48px; margin-bottom: 15px; }
    .confirm-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #333; }
    .confirm-box p { color: #666; font-size: 14px; margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 30px; right: 30px;
      padding: 14px 20px; border-radius: 10px; color: white;
      font-weight: 600; font-size: 14px; z-index: 9999;
      transform: translateY(100px); transition: transform 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .toast.show  { transform: translateY(0); }
    .toast.success { background: #10b981; }
    .toast.error   { background: #ef4444; }
  </style>
</head>
<body>

  <!-- EDIT MODAL -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>âœï¸ Edit Device</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Brand *</label>
          <input type="text" id="edit_brand" placeholder="Dell, HP, Lenovo...">
        </div>
        <div class="form-group">
          <label>Model *</label>
          <input type="text" id="edit_model" placeholder="OptiPlex 3020">
        </div>
        <div class="form-group">
          <label>Serial Number *</label>
          <input type="text" id="edit_serial">
        </div>
        <div class="form-group">
          <label>Device Type</label>
          <select id="edit_device_type">
            <option value="DESKTOP">Desktop</option>
            <option value="LAPTOP">Laptop</option>
          </select>
        </div>
        <div class="form-group">
          <label>Processor</label>
          <input type="text" id="edit_processor" placeholder="Intel i5-4590">
        </div>
        <div class="form-group">
          <label>RAM (GB)</label>
          <input type="number" id="edit_ram_gb" placeholder="4">
        </div>
        <div class="form-group">
          <label>Storage (GB)</label>
          <input type="number" id="edit_storage_gb" placeholder="500">
        </div>
        <div class="form-group">
          <label>Storage Type</label>
          <select id="edit_storage_type">
            <option value="HDD">HDD</option>
            <option value="SSD">SSD</option>
          </select>
        </div>
        <div class="form-group">
          <label>Monitor Size (inch)</label>
          <input type="number" id="edit_monitor_size" placeholder="19">
        </div>
        <div class="form-group">
          <label>Monthly Rent (â‚¹)</label>
          <input type="number" id="edit_monthly_rent" placeholder="1000">
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="edit_status">
            <option value="AVAILABLE">Available</option>
            <option value="DEPLOYED">Deployed</option>
            <option value="MAINTENANCE">Maintenance</option>
            <option value="RETIRED">Retired</option>
          </select>
        </div>
        <div class="form-group">
          <label>Security Deposit (â‚¹)</label>
          <input type="number" id="edit_security_deposit" placeholder="5000">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveDevice()">ğŸ’¾ Save Changes</button>
      </div>
    </div>
  </div>

  <!-- DELETE CONFIRM -->
  <div class="confirm-overlay" id="deleteConfirm">
    <div class="confirm-box">
      <div class="icon">ğŸ—‘ï¸</div>
      <h3>Device Delete Karen?</h3>
      <p id="deleteDeviceName">Ye device permanently delete ho jayega.</p>
      <div class="confirm-actions">
        <button class="btn btn-cancel" onclick="closeDeleteConfirm()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">ğŸ—‘ï¸ Delete</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <nav class="navbar">
    <h1>ğŸ” RentComPro - Devices</h1>
    <div class="nav-links">
      <a href="/dashboard.html">Dashboard</a>
      <a href="/manage-clients.html">Clients</a>
      <a href="/item-master.html">Item Master</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h2>ğŸ’» Device Management</h2>
      <button class="btn btn-primary" onclick="window.location.href='/add-device.html'">
        â• Add New Device
      </button>
    </div>

    <div class="stats-cards">
      <div class="stat-card available">
        <div class="icon">ğŸ“¦</div>
        <div class="label">Available</div>
        <div class="value" id="availableCount">0</div>
      </div>
      <div class="stat-card deployed">
        <div class="icon">âœ…</div>
        <div class="label">Deployed</div>
        <div class="value" id="deployedCount">0</div>
      </div>
      <div class="stat-card maintenance">
        <div class="icon">ğŸ”§</div>
        <div class="label">Maintenance</div>
        <div class="value" id="maintenanceCount">0</div>
      </div>
      <div class="stat-card retired">
        <div class="icon">ğŸ—‘ï¸</div>
        <div class="label">Retired</div>
        <div class="value" id="retiredCount">0</div>
      </div>
    </div>

    <div class="filters">
      <button class="filter-btn active" onclick="filterDevices('ALL', event)">All Devices</button>
      <button class="filter-btn" onclick="filterDevices('AVAILABLE', event)">Available</button>
      <button class="filter-btn" onclick="filterDevices('DEPLOYED', event)">Deployed</button>
      <button class="filter-btn" onclick="filterDevices('MAINTENANCE', event)">Maintenance</button>
      <button class="filter-btn" onclick="filterDevices('DESKTOP', event)">Desktops</button>
      <button class="filter-btn" onclick="filterDevices('LAPTOP', event)">Laptops</button>
      <input type="text" class="search-box" placeholder="ğŸ” Search by serial, brand, model..."
             oninput="searchDevices(this.value)">
    </div>

    <div id="devicesGrid" class="devices-grid">
      <div style="grid-column:1/-1;text-align:center;padding:60px;color:#999;">Loading devices...</div>
    </div>
  </div>

  <script>
    const API_URL = 'https://rentcompro-backend.brajesh-jimmc.workers.dev';
    let allDevices = [];

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = '/index.html'; return false; }
      return true;
    }

    async function loadDevices() {
      const token = localStorage.getItem('token');
      try {
        const res  = await fetch(`${API_URL}/api/devices`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          allDevices = data.data;
          updateStats();
          displayDevices(allDevices);
        }
      } catch (e) {
        document.getElementById('devicesGrid').innerHTML =
          '<div style="grid-column:1/-1;text-align:center;color:#dc3545;">Failed to load devices</div>';
      }
    }

    function updateStats() {
      document.getElementById('availableCount').textContent   = allDevices.filter(d => d.status === 'AVAILABLE').length;
      document.getElementById('deployedCount').textContent    = allDevices.filter(d => d.status === 'DEPLOYED').length;
      document.getElementById('maintenanceCount').textContent = allDevices.filter(d => d.status === 'MAINTENANCE').length;
      document.getElementById('retiredCount').textContent     = allDevices.filter(d => d.status === 'RETIRED').length;
    }

    function displayDevices(devices) {
      const grid = document.getElementById('devicesGrid');
      if (!devices.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:60px;">No devices found</div>';
        return;
      }
      grid.innerHTML = devices.map(d => {
        const sc = d.status.toLowerCase();
        return `
          <div class="device-card ${sc}">
            <div class="device-header">
              <span class="device-type">${d.device_type}</span>
              <span class="device-status ${sc}">${d.status}</span>
            </div>
            <div class="device-title">${d.brand || 'Unknown'} ${d.model || ''}</div>
            <div class="device-serial">SN: ${d.serial_number}</div>
            <div class="device-specs">
              <div class="spec-item">âš™ï¸ ${d.processor || 'N/A'}</div>
              <div class="spec-item">ğŸ’¾ ${d.ram_gb || 0}GB RAM</div>
              <div class="spec-item">ğŸ’¿ ${d.storage_gb || 0}GB ${d.storage_type || 'HDD'}</div>
              <div class="spec-item">ğŸ–¥ï¸ ${d.monitor_size || 0}" Monitor</div>
            </div>
            <div class="device-rent">â‚¹${d.monthly_rent || 0}/month</div>
            <div class="device-actions">
              <button class="btn btn-edit btn-sm" onclick="openEditModal('${d.id}')">âœï¸ Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteDevice('${d.id}','${(d.brand||'') + ' ' + (d.model||'')}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </div>`;
      }).join('');
    }

    function filterDevices(type, e) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if (e && e.target) e.target.classList.add('active');
      let filtered = allDevices;
      if (type === 'DESKTOP' || type === 'LAPTOP') filtered = allDevices.filter(d => d.device_type === type);
      else if (type !== 'ALL') filtered = allDevices.filter(d => d.status === type);
      displayDevices(filtered);
    }

    function searchDevices(q) {
      if (!q.trim()) { displayDevices(allDevices); return; }
      const s = q.toLowerCase();
      displayDevices(allDevices.filter(d =>
        d.serial_number.toLowerCase().includes(s) ||
        (d.brand  && d.brand.toLowerCase().includes(s)) ||
        (d.model  && d.model.toLowerCase().includes(s)) ||
        (d.processor && d.processor.toLowerCase().includes(s))
      ));
    }

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type} show`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // â”€â”€ EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let editingId = null;

    function openEditModal(id) {
      const d = allDevices.find(x => x.id === id);
      if (!d) return;
      editingId = id;
      document.getElementById('edit_brand').value          = d.brand || '';
      document.getElementById('edit_model').value          = d.model || '';
      document.getElementById('edit_serial').value         = d.serial_number || '';
      document.getElementById('edit_device_type').value    = d.device_type || 'DESKTOP';
      document.getElementById('edit_processor').value      = d.processor || '';
      document.getElementById('edit_ram_gb').value         = d.ram_gb || '';
      document.getElementById('edit_storage_gb').value     = d.storage_gb || '';
      document.getElementById('edit_storage_type').value   = d.storage_type || 'HDD';
      document.getElementById('edit_monitor_size').value   = d.monitor_size || '';
      document.getElementById('edit_monthly_rent').value   = d.monthly_rent || '';
      document.getElementById('edit_status').value         = d.status || 'AVAILABLE';
      document.getElementById('edit_security_deposit').value = d.security_deposit || '';
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingId = null;
    }

    async function saveDevice() {
      if (!editingId) return;
      const token = localStorage.getItem('token');
      const payload = {
        brand:            document.getElementById('edit_brand').value.trim(),
        model:            document.getElementById('edit_model').value.trim(),
        serial_number:    document.getElementById('edit_serial').value.trim(),
        device_type:      document.getElementById('edit_device_type').value,
        processor:        document.getElementById('edit_processor').value.trim(),
        ram_gb:           parseInt(document.getElementById('edit_ram_gb').value) || null,
        storage_gb:       parseInt(document.getElementById('edit_storage_gb').value) || null,
        storage_type:     document.getElementById('edit_storage_type').value,
        monitor_size:     parseInt(document.getElementById('edit_monitor_size').value) || null,
        monthly_rent:     parseFloat(document.getElementById('edit_monthly_rent').value) || null,
        status:           document.getElementById('edit_status').value,
        security_deposit: parseFloat(document.getElementById('edit_security_deposit').value) || null,
      };
      if (!payload.brand || !payload.model || !payload.serial_number) {
        showToast('Brand, Model aur Serial Number zaroori hain!', 'error'); return;
      }
      try {
        const res  = await fetch(`${API_URL}/api/devices/${editingId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) { showToast('Device update ho gaya! âœ…'); closeEditModal(); loadDevices(); }
        else showToast(data.error || 'Update failed', 'error');
      } catch { showToast('Network error!', 'error'); }
    }

    // â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let deletingId = null;

    function deleteDevice(id, name) {
      deletingId = id;
      document.getElementById('deleteDeviceName').textContent =
        `"${name.trim()}" permanently delete ho jayega. Ye undo nahi ho sakta!`;
      document.getElementById('deleteConfirm').classList.add('active');
    }

    function closeDeleteConfirm() {
      document.getElementById('deleteConfirm').classList.remove('active');
      deletingId = null;
    }

    async function confirmDelete() {
      if (!deletingId) return;
      const token = localStorage.getItem('token');
      try {
        const res  = await fetch(`${API_URL}/api/devices/${deletingId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) { showToast('Device delete ho gaya! ğŸ—‘ï¸'); closeDeleteConfirm(); loadDevices(); }
        else showToast(data.error || 'Delete failed', 'error');
      } catch { showToast('Network error!', 'error'); }
    }

    // Close on overlay click
    document.getElementById('editModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditModal(); });
    document.getElementById('deleteConfirm').addEventListener('click', e => { if (e.target === e.currentTarget) closeDeleteConfirm(); });

    if (checkAuth()) loadDevices();
  </script>
</body>
</html>
